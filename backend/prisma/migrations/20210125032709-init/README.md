# Migration `20210125032709-init`

This migration has been generated by etahoon at 1/25/2021, 5:27:09 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."PermissionAction" AS ENUM ('Appointment_Create')

CREATE TYPE "public"."PermissionLevel" AS ENUM ('Organization', 'Branch', 'Specialty', 'User')

ALTER TABLE "public"."Appointment" DROP COLUMN "specialty"

DROP TYPE "Specialty"

CREATE TABLE "public"."Role" (
"id" text   NOT NULL ,
"name" text   NOT NULL ,
"organizationId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Permission" (
"id" text   NOT NULL ,
"roleId" text   NOT NULL ,
"action" "PermissionAction"  NOT NULL ,
"level" "PermissionLevel"  NOT NULL ,
"organizationId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Rule" (
"id" text   NOT NULL ,
"organizationId" text   NOT NULL ,
"branchId" text   ,
"specialtyId" text   ,
"userId" text   ,
"permissionId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Branch" (
"id" text   NOT NULL ,
"name" text   NOT NULL ,
"organizationId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Specialty" (
"id" text   NOT NULL ,
"name" text   NOT NULL ,
"organizationId" text   NOT NULL ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."Role" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Permission" ADD FOREIGN KEY ("roleId")REFERENCES "public"."Role"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Permission" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Rule" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Rule" ADD FOREIGN KEY ("branchId")REFERENCES "public"."Branch"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."Rule" ADD FOREIGN KEY ("specialtyId")REFERENCES "public"."Specialty"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."Rule" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."Rule" ADD FOREIGN KEY ("permissionId")REFERENCES "public"."Permission"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Branch" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Specialty" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20210113170540-init..20210125032709-init
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource postgresql {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -34,11 +34,11 @@
   Female
   Male
 }
-enum Specialty {
-  Dentistry
-}
+// enum Specialty {
+//   Dentistry
+// }
 enum FieldType {
   Text
   Number
@@ -73,8 +73,13 @@
   item           Item[]
   hospital       Hospital[]
   surgery        Surgery[]
   patientSurgery PatientSurgery[]
+  roles          Role[]
+  permissions    Permission[]
+  rules          Rule[]
+  branchs        Branch[]
+  specialties    Specialty[]
 }
 model User {
   id               String             @id @default(uuid())
@@ -92,8 +97,9 @@
   avatar           String?
   position         Position
   events           Event[]
   inventoryHistory InventoryHistory[]
+  Rule             Rule[]
 }
 model Patient {
   id               String                @id @default(uuid())
@@ -117,9 +123,8 @@
   date         DateTime           @default(now())
   type         AppointmentType
   patient      Patient            @relation(fields: [patientId], references: [id])
   patientId    String
-  specialty    Specialty
   doctor       User               @relation(fields: [doctorId], references: [id])
   doctorId     String
   labs         String?            @default("[]")
   status       AppointmentStatus
@@ -128,26 +133,30 @@
   clinic       Clinic             @relation(fields: [clinicId], references: [id])
   clinicId     String
   notes        String?            @default("")
   prescription String?            @default("")
+  // specialty    Specialty          @relation(fields: [specialtyId], references: [id])
+  // specialtyId  String
+  // Specialty    Specialty?         @relation(fields: [specialtyId], references: [id])
+  // specialtyId  String?
 }
 model View {
-  id                   String           @id @default(uuid())
-  name                 String
-  type                 AppointmentType  @default(Examination)
-  user                 User             @relation(fields: [userId], references: [id])
-  userId               String
-  fieldGroups          FieldGroup[]
-  activeViewsStatuses  ViewStatus[]      
+  id                  String          @id @default(uuid())
+  name                String
+  type                AppointmentType @default(Examination)
+  user                User            @relation(fields: [userId], references: [id])
+  userId              String
+  fieldGroups         FieldGroup[]
+  activeViewsStatuses ViewStatus[]
 }
 model ViewStatus {
-  id            String @id @default(uuid())
-  user          User   @relation(fields: [userId], references: [id])
-  userId        String
-  activeView    View   @relation(fields: [activeViewId], references: [id])
-  activeViewId  String
+  id           String @id @default(uuid())
+  user         User   @relation(fields: [userId], references: [id])
+  userId       String
+  activeView   View   @relation(fields: [activeViewId], references: [id])
+  activeViewId String
 }
 model FieldGroup {
   id     String  @id @default(uuid())
@@ -349,9 +358,9 @@
   barcode          String?
   notes            String?
   organization     Organization       @relation(fields: [organizationId], references: [id])
   organizationId   String
-  inventoryItems    InventoryItem[]
+  inventoryItems   InventoryItem[]
   inventoryHistory InventoryHistory[]
 }
 model InventoryItem {
@@ -410,4 +419,68 @@
   organizationId String
   date           DateTime
   fees           Int?
 }
+
+// permissions
+
+enum PermissionAction {
+  Appointment_Create
+}
+
+enum PermissionLevel {
+  Organization
+  Branch
+  Specialty
+  User
+}
+
+model Role {
+  id             String       @id @default(uuid())
+  name           String
+  organization   Organization @relation(fields: [organizationId], references: [id])
+  organizationId String
+  permission     Permission[]
+}
+
+model Permission {
+  id             String           @id @default(uuid())
+  role           Role             @relation(fields: [roleId], references: [id])
+  roleId         String
+  action         PermissionAction
+  level          PermissionLevel
+  rules          Rule[]
+  organization   Organization     @relation(fields: [organizationId], references: [id])
+  organizationId String
+}
+
+model Rule {
+  id             String       @id @default(uuid())
+  organization   Organization @relation(fields: [organizationId], references: [id])
+  organizationId String
+  branch         Branch?      @relation(fields: [branchId], references: [id])
+  branchId       String?
+  specialty      Specialty?   @relation(fields: [specialtyId], references: [id])
+  specialtyId    String?
+  user           User?        @relation(fields: [userId], references: [id])
+  userId         String?
+  permission     Permission   @relation(fields: [permissionId], references: [id])
+  permissionId   String
+}
+
+model Branch {
+  id             String       @id @default(uuid())
+  name           String
+  organization   Organization @relation(fields: [organizationId], references: [id])
+  organizationId String
+  rules          Rule[]
+}
+
+model Specialty {
+  id             String       @id @default(uuid())
+  name           String
+  organization   Organization @relation(fields: [organizationId], references: [id])
+  organizationId String
+  rules          Rule[]
+}
+
+// end permission
```


