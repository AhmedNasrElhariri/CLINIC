# Migration `20210303012247-appointment-labs`

This migration has been generated by etahoon at 3/3/2021, 3:22:47 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."Appointment" DROP COLUMN "labs",
ADD COLUMN "prescriptionId" text   ,
ADD COLUMN "appointmentLabId" text   

CREATE TABLE "public"."Prescription" (
"id" text   NOT NULL ,
"medicineId" text   NOT NULL ,
"timingId" text   NOT NULL ,
"durationLength" integer   NOT NULL ,
"durationType" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."AppointmentLab" (
"id" text   NOT NULL ,
"testId" text   NOT NULL ,
"appointmentId" text   NOT NULL ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."Prescription" ADD FOREIGN KEY ("medicineId")REFERENCES "public"."Patient"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Prescription" ADD FOREIGN KEY ("timingId")REFERENCES "public"."Timing"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."AppointmentLab" ADD FOREIGN KEY ("testId")REFERENCES "public"."TestDefinition"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."AppointmentLab" ADD FOREIGN KEY ("appointmentId")REFERENCES "public"."Appointment"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Appointment" ADD FOREIGN KEY ("prescriptionId")REFERENCES "public"."Prescription"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20210302101502-add..20210303012247-appointment-labs
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource postgresql {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -158,8 +158,9 @@
   medicineHistory  MedicineHistory[]
   familyHistory    FamilyHistory[]
   inventoryHistory InventoryHistory[]
   patientSurgeries PatientSurgery[]
+  Prescription     Prescription[]
 }
 model Appointment {
   id               String             @id @default(uuid())
@@ -168,16 +169,46 @@
   patient          Patient            @relation(fields: [patientId], references: [id])
   patientId        String
   user             User               @relation(fields: [userId], references: [id])
   userId           String
-  labs             String?            @default("[]")
+  // labs             String?            @default("[]")
   status           AppointmentStatus
   data             AppointmentField[]
   collections      Collection[]
   notes            String?            @default("")
   patientSurgeries PatientSurgery[]
+  prescription     Prescription?      @relation(fields: [prescriptionId], references: [id])
+  prescriptionId   String?
+  labs             AppointmentLab[]
+  appointmentLabId String?
 }
+model Prescription {
+  id String @id @default(uuid())
+
+  medicine   Patient @relation(fields: [medicineId], references: [id])
+  medicineId String
+
+  timing   Timing @relation(fields: [timingId], references: [id])
+  timingId String
+
+  durationLength Int
+  durationType   String
+
+  appointment Appointment[]
+}
+
+model AppointmentLab {
+  id String @id @default(uuid())
+
+  test   TestDefinition @relation(fields: [testId], references: [id])
+  testId String
+
+  appointment   Appointment @relation(fields: [appointmentId], references: [id])
+  appointmentId String
+
+}
+
 model View {
   id                  String          @id @default(uuid())
   name                String
   type                AppointmentType @default(Examination)
@@ -244,12 +275,13 @@
 model Configuration {
   id                   String  @id @default(uuid())
   user                 User    @relation(fields: [userId], references: [id])
-  userId               String 
+  userId               String
+  enableInvoiceCounter Boolean @default(false)
   sessions             Json    @default("[]")
-  enableInvoiceCounter Boolean  @default(false) 
+
   @@unique([userId], name: "userid_unique_constraint")
 }
 model Week {
@@ -415,20 +447,22 @@
   PatientSurgery PatientSurgery[]
 }
 model TestDefinition {
-  id       String @id @default(uuid())
-  testName String
-  user     User   @relation(fields: [userId], references: [id])
-  userId   String
+  id             String           @id @default(uuid())
+  testName       String
+  user           User             @relation(fields: [userId], references: [id])
+  userId         String
+  AppointmentLab AppointmentLab[]
 }
 model Timing {
-  id         String @id @default(uuid())
-  name       String
-  printValue String
-  user       User   @relation(fields: [userId], references: [id])
-  userId     String
+  id           String         @id @default(uuid())
+  name         String
+  printValue   String
+  user         User           @relation(fields: [userId], references: [id])
+  userId       String
+  Prescription Prescription[]
 }
 model ImageDefinition {
   id        String @id @default(uuid())
```


