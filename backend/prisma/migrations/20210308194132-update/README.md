# Migration `20210308194132-update`

This migration has been generated by ahmed nasr at 3/8/2021, 9:41:32 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."TestDefinition" DROP CONSTRAINT "TestDefinition_userId_fkey"

ALTER TABLE "public"."AppointmentLab" DROP CONSTRAINT "AppointmentLab_testId_fkey"

ALTER TABLE "public"."LabDocument" DROP CONSTRAINT "LabDocument_testDefinitionId_fkey"

ALTER TABLE "public"."AppointmentLab" DROP COLUMN "testId",
ADD COLUMN "labDefinitionId" text   NOT NULL 

ALTER TABLE "public"."LabDocument" DROP COLUMN "testDefinitionId",
ADD COLUMN "labDefinitionId" text   NOT NULL 

ALTER TABLE "public"."MedicineDefinition" DROP COLUMN "medicineName",
DROP COLUMN "medicineForm",
ADD COLUMN "name" text   NOT NULL ,
ADD COLUMN "form" text   NOT NULL 

CREATE TABLE "public"."LabDefinition" (
"id" text   NOT NULL ,
"testName" text   NOT NULL ,
"category" text   NOT NULL ,
"userId" text   NOT NULL ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."LabDefinition" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."AppointmentLab" ADD FOREIGN KEY ("labDefinitionId")REFERENCES "public"."LabDefinition"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."LabDocument" ADD FOREIGN KEY ("patientId")REFERENCES "public"."Patient"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."LabDocument" ADD FOREIGN KEY ("labDefinitionId")REFERENCES "public"."LabDefinition"("id") ON DELETE CASCADE ON UPDATE CASCADE

DROP TABLE "public"."TestDefinition"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20210308151530-update..20210308194132-update
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource postgresql {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -107,10 +107,10 @@
   specialties      Specialty[]
   users            User[]
   userSpecialties  UserSpecialty[]
   patients         Patient[]
-  InventoryItem    InventoryItem[]
-  InventoryHistory InventoryHistory[]
+  inventoryItems   InventoryItem[]
+  inventoryHistory InventoryHistory[]
 }
 model User {
   id                  String               @id @default(uuid())
@@ -118,35 +118,35 @@
   email               String               @unique
   password            String
   organization        Organization         @relation(fields: [organizationId], references: [id])
   organizationId      String
+  permissions         Json                 @default("[]")
+  avatar              String?
   role                PermissionRole?      @relation(fields: [roleId], references: [id])
   roleId              String?
   appointments        Appointment[]
   views               View[]
   viewStatus          ViewStatus[]
   workingHours        WorkingHours[]
   snippets            Snippet[]
-  permissions         Json                 @default("[]")
-  avatar              String?
   position            Position
   events              Event[]
   inventoryHistory    InventoryHistory[]
   rules               Rule[]
   specialties         UserSpecialty[]
-  testDefinitions     TestDefinition[]
+  labDefinitions      LabDefinition[]
   imageDefinitions    ImageDefinition[]
   medicineDefinitions MedicineDefinition[]
   patientReports      PatientReport[]
   patients            Patient[]
   expenses            Expense[]
   revenues            Revenue[]
   configurations      Configuration?
-  InventoryItem       InventoryItem[]
-  Item                Item[]
-  Timing              Timing[]
-  LabCategory         LabCategory[]
-  ImageCategory       ImageCategory[]
+  inventoryItem       InventoryItem[]
+  item                Item[]
+  timing              Timing[]
+  labCategories       LabCategory[]
+  imageCategories     ImageCategory[]
 }
 model Patient {
   id               String                @id @default(uuid())
@@ -164,9 +164,10 @@
   medicineHistory  MedicineHistory[]
   familyHistory    FamilyHistory[]
   inventoryHistory InventoryHistory[]
   patientSurgeries PatientSurgery[]
-  Prescription     Prescription[]
+  prescription     Prescription[]
+  labDocument      LabDocument[]
 }
 model Appointment {
   id               String             @id @default(uuid())
@@ -175,9 +176,8 @@
   patient          Patient            @relation(fields: [patientId], references: [id])
   patientId        String
   user             User               @relation(fields: [userId], references: [id])
   userId           String
-  // labs             String?            @default("[]")
   status           AppointmentStatus
   data             AppointmentField[]
   collections      Collection[]
   notes            String?            @default("")
@@ -205,10 +205,10 @@
 model AppointmentLab {
   id String @id @default(uuid())
-  test   TestDefinition @relation(fields: [testId], references: [id])
-  testId String
+  labDefinition   LabDefinition @relation(fields: [labDefinitionId], references: [id])
+  labDefinitionId String
   appointment   Appointment @relation(fields: [appointmentId], references: [id])
   appointmentId String
@@ -275,9 +275,9 @@
   collection   Collection?   @relation(fields: [collectionId], references: [id])
   collectionId String?
   mimetype     String?
   encoding     String?
-  labDocument  LabDocument[]
+  labDocuments LabDocument[]
 }
 model Configuration {
   id                   String  @id @default(uuid())
@@ -317,18 +317,19 @@
   body   String
 }
 model LabDocument {
-  id               String         @id @default(uuid())
-  testDefinition   TestDefinition @relation(fields: [testDefinitionId], references: [id])
-  file             File?          @relation(fields: [fileId], references: [id])
-  fileId           String?
-  status           LabDocStatus
-  requiredDate     DateTime       @default(now())
-  resultDate       DateTime?
-  value            String?
-  patientId        String
-  testDefinitionId String
+  id              String        @id @default(uuid())
+  status          LabDocStatus
+  requiredDate    DateTime      @default(now())
+  resultDate      DateTime?
+  value           String?
+  patinet         Patient       @relation(fields: [patientId], references: [id])
+  patientId       String
+  labDefinition   LabDefinition @relation(fields: [labDefinitionId], references: [id])
+  labDefinitionId String
+  file            File?         @relation(fields: [fileId], references: [id])
+  fileId          String?
 }
 model MedicineHistory {
   id           String    @id @default(uuid())
@@ -447,16 +448,16 @@
   organizationId String
   PatientSurgery PatientSurgery[]
 }
-model TestDefinition {
-  id             String           @id @default(uuid())
-  testName       String
-  category       String
-  user           User             @relation(fields: [userId], references: [id])
-  userId         String
-  AppointmentLab AppointmentLab[]
-  LabDocument    LabDocument[]
+model LabDefinition {
+  id           String           @id @default(uuid())
+  testName     String
+  category     String
+  user         User             @relation(fields: [userId], references: [id])
+  userId       String
+  labs         AppointmentLab[]
+  labDocuments LabDocument[]
 }
 model LabCategory {
   id     String @id @default(uuid())
@@ -491,11 +492,11 @@
 }
 model MedicineDefinition {
   id            String @id @default(uuid())
-  medicineName  String
+  name          String
   concentration String
-  medicineForm  String
+  form          String
   user          User   @relation(fields: [userId], references: [id])
   userId        String
 }
```


